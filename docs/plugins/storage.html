<!DOCTYPE html>
<html lang="fr">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Documentation: plugins_utils/storage.py</title>
  <link rel="stylesheet" href="docs_style.css">
  <style>
    /* Style additionnel pour les avertissements forts */
    .destructive-warning {
      color: #dc3545;
      /* Rouge vif */
      background-color: #f8d7da;
      border: 1px solid #f1aeb5;
      font-weight: 700;
      /* Gras */
      padding: 0.75rem;
      margin-top: 0.5rem;
      margin-bottom: 1rem;
      border-radius: 4px;
    }

    .destructive-warning::before {
      content: "üö® ATTENTION: ";
    }
  </style>
</head>

<body>
  <div class="container">

    <h1 class="main-title">Documentation: <code>plugins_utils/storage.py</code></h1>

    <p class="module-description">
      Ce module fournit des utilitaires pour la gestion du stockage : p√©riph√©riques blocs
      (disques, partitions), syst√®mes de fichiers, points de montage et utilisation disque.
      Il utilise les commandes <code>lsblk</code>, <code>mkfs.*</code>, <code>mount</code>,
      <code>umount</code>, <code>findmnt</code>, <code>df</code>, <code>du</code>, <code>blkid</code>.
      Les op√©rations de partitionnement avanc√©es (cr√©ation/suppression) ne sont pas incluses
      en raison de leur complexit√© et des risques associ√©s.
    </p>

    <nav class="toc">
      <h3 class="toc-title">Acc√®s Rapide aux M√©thodes</h3>
      <ul class="toc-list">
        <li class="toc-item"><a href="#list_block_devices" class="toc-link">list_block_devices</a></li>
        <li class="toc-item"><a href="#get_filesystem_info" class="toc-link">get_filesystem_info</a></li>
        <li class="toc-item"><a href="#format_partition" class="toc-link">format_partition</a></li>
        <li class="toc-item"><a href="#mount" class="toc-link">mount</a></li>
        <li class="toc-item"><a href="#umount" class="toc-link">umount</a></li>
        <li class="toc-item"><a href="#is_mounted" class="toc-link">is_mounted</a></li>
        <li class="toc-item"><a href="#get_mount_info" class="toc-link">get_mount_info</a></li>
        <li class="toc-item"><a href="#add_fstab_entry" class="toc-link">add_fstab_entry</a></li>
        <li class="toc-item"><a href="#remove_fstab_entry" class="toc-link">remove_fstab_entry</a></li>
        <li class="toc-item"><a href="#get_disk_usage" class="toc-link">get_disk_usage</a></li>
        <li class="toc-item"><a href="#get_dir_usage" class="toc-link">get_dir_usage</a></li>
      </ul>
    </nav>

    <h2 class="section-title">Classe Principale</h2>

    <section class="method-section">
      <h3 class="method-title" id="StorageCommands"><code>StorageCommands(PluginUtilsBase)</code></h3>
      <p class="description">
        Classe pour g√©rer le stockage (p√©riph√©riques, syst√®mes de fichiers, montage).
        H√©rite de <code>PluginUtilsBase</code> pour l'ex√©cution des commandes et la journalisation.
      </p>
    </section>

    <h2 class="section-title">M√©thodes Principales</h2>

    <section class="method-section">
      <h4 class="method-title" id="list_block_devices">
        <code>list_block_devices(device: Optional[str] = None) -> List[Dict[str, Any]]</code></h4>
      <p class="description">Liste les p√©riph√©riques blocs (disques et partitions) via <code>lsblk -J -b -o ...</code>.
      </p>
      <dl class="param-list">
        <dt>device</dt>
        <dd><span class="param-type">(Optional[str])</span>: Chemin du p√©riph√©rique sp√©cifique √† lister (ex: /dev/sda)
          ou None pour tous.</dd>
      </dl>
      <div class="return-info">
        <span class="font-medium">Retourne:</span><span class="return-type">List[Dict[str, Any]]</span> - Liste de
        dictionnaires, chaque dict repr√©sentant un p√©riph√©rique bloc (disque ou partition) avec des cl√©s comme 'name',
        'path', 'size' (octets), 'type', 'fstype', 'label', 'uuid', 'mountpoint', 'model', 'serial', 'ro' (bool), 'rm'
        (bool), etc. Retourne une liste vide en cas d'erreur.
      </div>
    </section>

    <section class="method-section">
      <h4 class="method-title" id="get_filesystem_info">
        <code>get_filesystem_info(device: str) -> Optional[Dict[str, str]]</code></h4>
      <p class="description">R√©cup√®re les informations du syst√®me de fichiers sur un p√©riph√©rique via
        <code>blkid -p -o full</code>.</p>
      <p class="sudo-warning">N√©cessite g√©n√©ralement des privil√®ges root (pour l'option -p).</p>
      <dl class="param-list">
        <dt>device</dt>
        <dd><span class="param-type">(str)</span>: Chemin du p√©riph√©rique (ex: /dev/sda1).</dd>
      </dl>
      <div class="return-info">
        <span class="font-medium">Retourne:</span><span class="return-type">Optional[Dict[str, str]]</span> -
        Dictionnaire avec les infos (TYPE, UUID, LABEL, PARTUUID, etc.) ou None si erreur ou si aucun syst√®me de
        fichiers n'est d√©tect√©.
      </div>
    </section>

    <section class="method-section">
      <h4 class="method-title" id="format_partition"><code>format_partition(...) -> bool</code></h4>
      <p class="description">Formate une partition avec un syst√®me de fichiers sp√©cifi√© via <code>mkfs.*</code>.</p>
      <p class="destructive-warning">Op√©ration destructive ! Toutes les donn√©es sur la partition seront perdues.</p>
      <p class="sudo-warning">N√©cessite des privil√®ges root.</p>
      <div class="method-signature">
        <pre><code>format_partition(
    partition: str,
    fs_type: str,
    label: Optional[str] = None,
    options: Optional[List[str]] = None
) -> bool</code></pre>
      </div>
      <dl class="param-list">
        <dt>partition</dt>
        <dd><span class="param-type">(str)</span>: Chemin de la partition (ex: /dev/sda1).</dd>
        <dt>fs_type</dt>
        <dd><span class="param-type">(str)</span>: Type de syst√®me de fichiers (ext4, xfs, vfat, ntfs, etc.).</dd>
        <dt>label</dt>
        <dd><span class="param-type">(Optional[str])</span>: Label √† assigner au syst√®me de fichiers (optionnel).</dd>
        <dt>options</dt>
        <dd><span class="param-type">(Optional[List[str]])</span>: Options suppl√©mentaires √† passer √† la commande mkfs
          (ex: ['-O', '^has_journal']).</dd>
      </dl>
      <div class="return-info">
        <span class="font-medium">Retourne:</span><span class="return-type">bool</span> - True si le formatage a r√©ussi.
      </div>
    </section>

    <section class="method-section">
      <h4 class="method-title" id="mount"><code>mount(...) -> bool</code></h4>
      <p class="description">Monte un p√©riph√©rique sur un point de montage via <code>mount</code>.</p>
      <p class="sudo-warning">N√©cessite des privil√®ges root.</p>
      <div class="method-signature">
        <pre><code>mount(
    device: str,
    mount_point: str,
    fs_type: Optional[str] = None,
    options: Optional[Union[str, List[str]]] = None,
    create_mount_point: bool = True
) -> bool</code></pre>
      </div>
      <dl class="param-list">
        <dt>device</dt>
        <dd><span class="param-type">(str)</span>: P√©riph√©rique √† monter (ex: /dev/sda1, UUID=..., LABEL=...).</dd>
        <dt>mount_point</dt>
        <dd><span class="param-type">(str)</span>: Chemin du point de montage.</dd>
        <dt>fs_type</dt>
        <dd><span class="param-type">(Optional[str])</span>: Type de syst√®me de fichiers (optionnel, mount essaie de
          d√©tecter).</dd>
        <dt>options</dt>
        <dd><span class="param-type">(Optional[Union[str, List[str]]])</span>: Options de montage (cha√Æne ou liste, ex:
          'ro,noatime' ou ['ro', 'noatime']).</dd>
        <dt>create_mount_point</dt>
        <dd><span class="param-type">(bool)</span>: Si True (d√©faut), cr√©e le dossier du point de montage s'il n'existe
          pas.</dd>
      </dl>
      <div class="return-info">
        <span class="font-medium">Retourne:</span><span class="return-type">bool</span> - True si le montage a r√©ussi
        (ou si d√©j√† mont√© correctement).
      </div>
    </section>

    <section class="method-section">
      <h4 class="method-title" id="umount">
        <code>umount(mount_point_or_device: str, force: bool = False, lazy: bool = False) -> bool</code></h4>
      <p class="description">D√©monte un syst√®me de fichiers via <code>umount</code>.</p>
      <p class="sudo-warning">N√©cessite des privil√®ges root.</p>
      <dl class="param-list">
        <dt>mount_point_or_device</dt>
        <dd><span class="param-type">(str)</span>: Point de montage ou p√©riph√©rique √† d√©monter.</dd>
        <dt>force</dt>
        <dd><span class="param-type">(bool)</span>: Forcer le d√©montage (-f). Attention: peut causer des pertes de
          donn√©es.</dd>
        <dt>lazy</dt>
        <dd><span class="param-type">(bool)</span>: D√©montage "paresseux" (-l). D√©tache le FS de la hi√©rarchie
          imm√©diatement.</dd>
      </dl>
      <div class="return-info">
        <span class="font-medium">Retourne:</span><span class="return-type">bool</span> - True si le d√©montage a r√©ussi
        (ou si d√©j√† d√©mont√©).
      </div>
    </section>

    <section class="method-section">
      <h4 class="method-title" id="is_mounted"><code>is_mounted(mount_point_or_device: str) -> bool</code></h4>
      <p class="description">V√©rifie si un point de montage ou un p√©riph√©rique est actuellement mont√© via
        <code>findmnt</code>.</p>
      <dl class="param-list">
        <dt>mount_point_or_device</dt>
        <dd><span class="param-type">(str)</span>: Point de montage ou p√©riph√©rique √† v√©rifier.</dd>
      </dl>
      <div class="return-info">
        <span class="font-medium">Retourne:</span><span class="return-type">bool</span> - True s'il est mont√©, False
        sinon.
      </div>
    </section>

    <section class="method-section">
      <h4 class="method-title" id="get_mount_info">
        <code>get_mount_info(mount_point_or_device: Optional[str] = None) -> List[Dict[str, str]]</code></h4>
      <p class="description">R√©cup√®re les informations sur les points de montage actuels via
        <code>findmnt -J -o ...</code>.</p>
      <dl class="param-list">
        <dt>mount_point_or_device</dt>
        <dd><span class="param-type">(Optional[str])</span>: Filtrer par point de montage ou p√©riph√©rique (optionnel).
        </dd>
      </dl>
      <div class="return-info">
        <span class="font-medium">Retourne:</span><span class="return-type">List[Dict[str, str]]</span> - Liste de
        dictionnaires contenant les informations de montage (TARGET, SOURCE, FSTYPE, OPTIONS). Retourne liste vide si
        erreur ou non trouv√©.
      </div>
    </section>

    <section class="method-section">
      <h4 class="method-title" id="add_fstab_entry"><code>add_fstab_entry(...) -> bool</code></h4>
      <p class="description">Ajoute (ou remplace si marqueur trouv√©) une entr√©e dans <code>/etc/fstab</code>.</p>
      <p class="destructive-warning">Modifier /etc/fstab peut rendre le syst√®me non d√©marrable si une erreur est
        commise.</p>
      <p class="sudo-warning">N√©cessite des privil√®ges root.</p>
      <div class="method-signature">
        <pre><code>add_fstab_entry(
    device: str,
    mount_point: str,
    fs_type: str,
    options: str = 'defaults',
    dump: int = 0,
    pass_num: int = 0,
    marker: Optional[str] = None,
    backup: bool = True
) -> bool</code></pre>
      </div>
      <dl class="param-list">
        <dt>device</dt>
        <dd><span class="param-type">(str)</span>: P√©riph√©rique (ex: /dev/sda1, UUID=..., LABEL=...).</dd>
        <dt>mount_point</dt>
        <dd><span class="param-type">(str)</span>: Point de montage.</dd>
        <dt>fs_type</dt>
        <dd><span class="param-type">(str)</span>: Type de syst√®me de fichiers.</dd>
        <dt>options</dt>
        <dd><span class="param-type">(str)</span>: Options de montage (ex: 'defaults,noatime').</dd>
        <dt>dump</dt>
        <dd><span class="param-type">(int)</span>: Champ dump (g√©n√©ralement 0).</dd>
        <dt>pass_num</dt>
        <dd><span class="param-type">(int)</span>: Champ pass (0 pour ne pas v√©rifier, 1 pour root, 2 pour autres).</dd>
        <dt>marker</dt>
        <dd><span class="param-type">(Optional[str])</span>: Commentaire marqueur unique (<code># MARKER:marker</code>)
          pour identifier/remplacer l'entr√©e.</dd>
        <dt>backup</dt>
        <dd><span class="param-type">(bool)</span>: Si True (d√©faut), cr√©e une sauvegarde de /etc/fstab avant
          modification.</dd>
      </dl>
      <div class="return-info">
        <span class="font-medium">Retourne:</span><span class="return-type">bool</span> - True si l'ajout/modification a
        r√©ussi.
      </div>
    </section>

    <section class="method-section">
      <h4 class="method-title" id="remove_fstab_entry"><code>remove_fstab_entry(...) -> bool</code></h4>
      <p class="description">Supprime une entr√©e de <code>/etc/fstab</code> bas√©e sur le point de montage, le
        p√©riph√©rique ou un marqueur.</p>
      <p class="destructive-warning">Modifier /etc/fstab peut rendre le syst√®me non d√©marrable.</p>
      <p class="sudo-warning">N√©cessite des privil√®ges root.</p>
      <div class="method-signature">
        <pre><code>remove_fstab_entry(
    mount_point_or_device: Optional[str] = None,
    marker: Optional[str] = None,
    backup: bool = True
) -> bool</code></pre>
      </div>
      <dl class="param-list">
        <dt>mount_point_or_device</dt>
        <dd><span class="param-type">(Optional[str])</span>: Point de montage ou p√©riph√©rique de l'entr√©e √† supprimer.
          Utilis√© si <code>marker</code> est None.</dd>
        <dt>marker</dt>
        <dd><span class="param-type">(Optional[str])</span>: Marqueur unique (<code># MARKER:marker</code>) de l'entr√©e
          √† supprimer (prioritaire).</dd>
        <dt>backup</dt>
        <dd><span class="param-type">(bool)</span>: Cr√©er une sauvegarde avant modification.</dd>
      </dl>
      <div class="return-info">
        <span class="font-medium">Retourne:</span><span class="return-type">bool</span> - True si succ√®s ou si l'entr√©e
        n'a pas √©t√© trouv√©e. False si erreur.
      </div>
    </section>

    <section class="method-section">
      <h4 class="method-title" id="get_disk_usage">
        <code>get_disk_usage(path: Optional[str] = None) -> List[Dict[str, str]]</code></h4>
      <p class="description">R√©cup√®re l'utilisation disque des syst√®mes de fichiers mont√©s via <code>df -Pk</code>.</p>
      <dl class="param-list">
        <dt>path</dt>
        <dd><span class="param-type">(Optional[str])</span>: Chemin sp√©cifique √† v√©rifier ou None pour tous les syst√®mes
          de fichiers.</dd>
      </dl>
      <div class="return-info">
        <span class="font-medium">Retourne:</span><span class="return-type">List[Dict[str, str]]</span> - Liste de
        dictionnaires avec les informations df (Filesystem, Size(k), Used(k), Avail(k), UsePct, MountedOn). Retourne
        liste vide si erreur.
      </div>
    </section>

    <section class="method-section">
      <h4 class="method-title" id="get_dir_usage">
        <code>get_dir_usage(path: str, summary: bool = True, apparent_size: bool = False) -> Optional[Tuple[int, str]]</code>
      </h4>
      <p class="description">R√©cup√®re la taille occup√©e par un r√©pertoire via <code>du</code>.</p>
      <p class="sudo-warning">Peut n√©cessiter des privil√®ges root pour lire le contenu de certains r√©pertoires.</p>
      <dl class="param-list">
        <dt>path</dt>
        <dd><span class="param-type">(str)</span>: Chemin du r√©pertoire.</dd>
        <dt>summary</dt>
        <dd><span class="param-type">(bool)</span>: Si True (d√©faut), affiche seulement le total (-s).</dd>
        <dt>apparent_size</dt>
        <dd><span class="param-type">(bool)</span>: Si True, utilise la taille apparente (--apparent-size).</dd>
      </dl>
      <div class="return-info">
        <span class="font-medium">Retourne:</span><span class="return-type">Optional[Tuple[int, str]]</span> - Tuple
        (taille_en_ko: int, taille_lisible: str) ou None si erreur.
      </div>
    </section>

  </div>
</body>

</html>